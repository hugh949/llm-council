# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - llm-council-app

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ðŸ› ï¸ Local Build Section (Optional)
      # The following section in your workflow is designed to catch build issues early on the client side, before deployment. This can be helpful for debugging and validation. However, if this step significantly increases deployment time and early detection is not critical for your workflow, you may remove this section to streamline the deployment process.
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build frontend
        run: |
          cd frontend
          npm install
          npm run build
          cd ..
          
      - name: Copy frontend build to backend static
        run: |
          mkdir -p backend/static
          rm -rf backend/static/*
          cp -r frontend/dist/* backend/static/
          
      - name: Create and Start virtual environment and Install dependencies
        run: |
          python -m venv antenv
          source antenv/bin/activate
          pip install -r requirements.txt
                
      # By default, when you enable GitHub CI/CD integration through the Azure portal, the platform automatically sets the SCM_DO_BUILD_DURING_DEPLOYMENT application setting to true. This triggers the use of Oryx, a build engine that handles application compilation and dependency installation (e.g., pip install) directly on the platform during deployment. Hence, we exclude the antenv virtual environment directory from the deployment artifact to reduce the payload size. 
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            .
            !antenv/
            !frontend/node_modules/
            !frontend/dist/

      # ðŸš« Opting Out of Oryx Build
      # If you prefer to disable the Oryx build process during deployment, follow these steps:
      # 1. Remove the SCM_DO_BUILD_DURING_DEPLOYMENT app setting from your Azure App Service Environment variables.
      # 2. Refer to sample workflows for alternative deployment strategies: https://github.com/Azure/actions-workflow-samples/tree/master/AppService
      

  deploy:
    runs-on: ubuntu-latest
    needs: build
    # Prevent multiple deployments from running simultaneously
    concurrency:
      group: deploy-llm-council-app
      cancel-in-progress: false
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_DBA790EC6B7B4C36A7D72035F0B10B2D }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_BA798101DEC34D62ABD58C04BC668CB4 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_67F6A97CB75D41F7B59C50165ADA51A2 }}

      - name: Wait for any ongoing deployments and clear locks
        run: |
          echo "Checking for ongoing deployments..."
          APP_NAME="llm-council-app"
          RESOURCE_GROUP=$(az webapp show --name $APP_NAME --query resourceGroup -o tsv)
          
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "Could not find resource group for app. Proceeding with deployment..."
            exit 0
          fi
          
          echo "Resource group: $RESOURCE_GROUP"
          
          # Check app service state
          APP_STATE=$(az webapp show --name $APP_NAME --resource-group $RESOURCE_GROUP --query state -o tsv 2>/dev/null || echo "")
          echo "App service state: $APP_STATE"
          
          # If app is stopped, start it
          if [ "$APP_STATE" = "Stopped" ]; then
            echo "App service is stopped. Starting it..."
            az webapp start --name $APP_NAME --resource-group $RESOURCE_GROUP || true
            echo "Waiting 10 seconds for app to start..."
            sleep 10
          fi
          
          MAX_WAIT=300  # 5 minutes max wait
          WAIT_INTERVAL=10  # Check every 10 seconds
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Check for active deployments using deployment history
            ACTIVE_COUNT=$(az webapp deployment list \
              --name $APP_NAME \
              --resource-group $RESOURCE_GROUP \
              --query "[?status=='Running' || status=='InProgress'].id" \
              -o tsv 2>/dev/null | wc -l || echo "0")
            
            if [ "$ACTIVE_COUNT" = "0" ] || [ -z "$ACTIVE_COUNT" ]; then
              echo "No active deployments found. Proceeding..."
              break
            fi
            
            echo "Active deployment(s) detected (count: $ACTIVE_COUNT). Waiting... (${ELAPSED}s / ${MAX_WAIT}s)"
            sleep $WAIT_INTERVAL
            ELAPSED=$((ELAPSED + WAIT_INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "Warning: Timeout waiting for deployments. Attempting to clear locks..."
            # Try to stop and start the app to clear any locks (minimal downtime)
            echo "Restarting app service to clear locks..."
            az webapp restart --name $APP_NAME --resource-group $RESOURCE_GROUP || true
            echo "Waiting 15 seconds for app to restart..."
            sleep 15
          else
            # Additional wait to ensure any locks are cleared
            echo "Waiting 5 seconds to ensure locks are cleared..."
            sleep 5
          fi

      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        continue-on-error: false
        timeout-minutes: 20
        with:
          app-name: 'llm-council-app'
          slot-name: 'Production'
          package: '.'
          startup-command: ''
          